<?xml version="1.0" encoding="utf-8"?>
<beast>
    <taxa>
        <taxa>
            <taxon id="taxon_1">
                <attr name="factors">0.0076177742633394985 0.04658821120386576 -0.454549337998158</attr>
                <attr name="traits">0.6516453793311435 -0.30672526997380434 -1.0662258001632197 NA NA
                    1.0862726198933823
                </attr>
                <attr name="factors2">-0.1427515249906789 -0.9762377946192438 1.5409081543409757</attr>
                <attr name="traits2">1.045832431389519 0.4136817728340274 -0.09811198697843115 NA NA
                    0.9581424818529855
                </attr>
            </taxon>
            <taxon id="taxon_2">
                <attr name="factors">0.05702524809146323 1.0015698840090395 -1.5146279580725215</attr>
                <attr name="traits">0.6325785236662933 2.1458418845262095 -4.02252759844451 -2.199839091348439
                    0.29503380579945926 1.6022530940653703
                </attr>
                <attr name="factors2">-0.76494589666848 0.8926159486408304 -0.21910826729514443</attr>
                <attr name="traits2">-0.9763418164860428 1.1340483630341385 -1.8879064540962252 0.3404372250993941
                    0.1844449916003127 -1.0406957527381338
                </attr>
            </taxon>
            <taxon id="taxon_3">
                <attr name="factors">-0.5484010117038763 -0.42898479922720356 0.6436374468251037</attr>
                <attr name="traits">0.06710387175615268 -0.6551615290007992 -0.1558341260039633 0.9809281618519776 NA
                    2.2757398638433024
                </attr>
                <attr name="factors2">-0.7753036091755111 -0.6310523042807586 -0.884732156688886</attr>
                <attr name="traits2">-0.6889751511190905 1.0273087350841408 -0.32630421730109477 0.9975507049607159 NA
                    0.250636674556317
                </attr>
            </taxon>
            <taxon id="taxon_4">
                <attr name="factors">0.3515255484089337 0.09104086929644847 -1.426378176957026</attr>
                <attr name="traits">1.8381550901151866 0.7100323532823356 -0.46336620339680973 0.6929385483268955
                    1.4246416564479647 0.7978312892852549
                </attr>
                <attr name="factors2">0.06407218628880325 -1.3138399795485036 -0.908492078896604</attr>
                <attr name="traits2">1.4679956241608012 -0.033597626739283515 -0.9662543614431232 0.07988203196594053
                    -1.9737902929363504 -0.07029864112047372
                </attr>
            </taxon>
            <taxon id="taxon_5">
                <attr name="factors">-0.784929798992992 -0.8970245252413375 1.5439602691637375</attr>
                <attr name="traits">0.0316690080373222 -1.7576226586590344 1.1840692291157067 NA NA
                    -1.1147162532561403
                </attr>
                <attr name="factors2">0.05507223762229884 -1.1748551059744266 1.1319205607675884</attr>
                <attr name="traits2">0.7026469551990844 1.5902829389946656 1.1718015725579902 NA NA 0.6487716919350144
                </attr>
            </taxon>
            <taxon id="taxon_6">
                <attr name="factors">0.24501763591278475 0.4270454816694809 -0.16450480870919917</attr>
                <attr name="traits">-1.5117818459617285 0.6142497294867271 -1.0719594995347204 0.17717747134170958
                    0.25141001101997984 2.5713722001003765
                </attr>
                <attr name="factors2">-0.17103119940289752 1.7121994436828467 -0.540876737598856</attr>
                <attr name="traits2">-1.5066848335126473 0.272136147887169 1.718050723742728 -1.7135270227271688
                    0.25009505164097723 -0.12985853692457772
                </attr>
            </taxon>
            <taxon id="taxon_7">
                <attr name="factors">0.30611493207760276 -0.8920557774375898 -0.16240458275087258</attr>
                <attr name="traits">2.376998869152794 -1.288954973667512 1.9653139535393538 2.2591172651509472
                    0.7033139566852135 -2.0051988957891833
                </attr>
                <attr name="factors2">-0.2052922205523524 -0.050723794124526815 -0.8530272179341484</attr>
                <attr name="traits2">-0.21993623046215738 0.003303093927661326 -0.37828587025567717 -0.24873143796379724
                    0.8084047625956468 0.3339311437326493
                </attr>
            </taxon>
            <taxon id="taxon_8">
                <attr name="factors">-1.0304943902767967 -0.8909827170981991 -0.39339506737983243</attr>
                <attr name="traits">3.7489584330186037 -1.6120214352492708 1.229095829253043 -0.9461771288238325
                    -0.5414270188384662 0.1963933988118387
                </attr>
                <attr name="factors2">-1.320689790676592 1.0223306847463705 0.5268638272696512</attr>
                <attr name="traits2">0.586584145794969 -0.7651534786320728 0.6226474307475715 0.2813056556276766
                    -0.20092798377805954 -1.8934986794262336
                </attr>
            </taxon>
            <taxon id="taxon_9">
                <attr name="factors">-0.21629784327601548 -0.11560476062111587 0.8655080462439241</attr>
                <attr name="traits">0.1098051185822364 -0.8354209207733001 -0.9408605927811101 -0.6052366430815324 NA
                    -1.899585962165238
                </attr>
                <attr name="factors2">0.18739305920640129 -1.5179723408106154 1.1401589934254803</attr>
                <attr name="traits2">-1.4377678637493523 -0.5409750709217968 1.454151808172188 -0.06980076643641078 NA
                    -0.10065000560648601
                </attr>
            </taxon>
            <taxon id="taxon_10">
                <attr name="factors">-2.132446790112065 -0.7122666957434696 -0.17865180808229236</attr>
                <attr name="traits">2.6838414469174605 -2.1315965518222804 2.0018397831496473 -0.07311489093054435
                    0.007730702344034168 -0.6319030277655954
                </attr>
                <attr name="factors2">1.857641004164723 0.23216648834283485 -1.5623915611149461</attr>
                <attr name="traits2">0.9860958511733682 0.18809554990388103 -1.1031430408308445 1.0821474474888186
                    -0.3880748220629019 0.9013768876292776
                </attr>
            </taxon>
            <taxon id="taxon_11">
                <attr name="factors">-0.3930227002265834 -0.8666572905938715 -0.5001246338040305</attr>
                <attr name="traits">2.837040489149912 -1.8973050606685875 2.3271956919825123 NA 0.7746748939419622
                    -1.3995208334770814
                </attr>
                <attr name="factors2">-0.10928634493525792 -1.2133058518108453 1.2531943267046417</attr>
                <attr name="traits2">-0.4446642765092675 -1.2383211793167312 -0.650361438870187 NA -0.001551025159085228
                    -0.6957989809881509
                </attr>
            </taxon>
            <taxon id="taxon_12">
                <attr name="factors">1.712948337244973 2.3897801345872987 0.8960512885879615</attr>
                <attr name="traits">NA 4.011276726695137 -6.033559189872468 -3.9124036703618366 -1.50713519850089
                    2.789226659002523
                </attr>
                <attr name="factors2">0.5191793798458271 -0.4259398152867588 -0.2726079993066857</attr>
                <attr name="traits2">NA -0.5664543137678593 0.013639868527778974 -0.5829372153188221 -1.6857578876727803
                    0.12110307673505301
                </attr>
            </taxon>
            <taxon id="taxon_13">
                <attr name="factors">-0.05945162267545193 -0.3440100523685048 -0.09729958495856225</attr>
                <attr name="traits">0.6139922543514983 -0.3984400274642017 1.1097378876612587 NA -0.7645437571511162
                    0.28866471489805057
                </attr>
                <attr name="factors2">0.6328099336345797 -0.3056748246811895 0.7928486212836258</attr>
                <attr name="traits2">0.2334121811823706 -0.9981245809135479 0.5981434436348021 NA -0.02338761320366489
                    0.9891175021843821
                </attr>
            </taxon>
            <taxon id="taxon_14">
                <attr name="factors">0.2079912019698792 0.38443026317349643 -0.7790116303715932</attr>
                <attr name="traits">0.09090853479382373 0.33378743492916796 -0.25188477261553754 -1.4767322764008375
                    0.3961425149247593 0.903095688374252
                </attr>
                <attr name="factors2">-0.8813851967269309 0.053360625039842756 1.0962404721739925</attr>
                <attr name="traits2">0.20995842143610133 -0.3588585707563652 0.1951535693812173 1.323610525039952
                    -2.198680996374538 1.5747971740619042
                </attr>
            </taxon>
            <taxon id="taxon_15">
                <attr name="factors">1.4061412930408388 0.7619824434342454 0.09081342420693704</attr>
                <attr name="traits">NA 1.4511796734070117 -1.7486590133121946 -1.7382795735252825 NA NA</attr>
                <attr name="factors2">-0.3840903490930811 0.7783785332321066 -1.8578771649532833</attr>
                <attr name="traits2">NA -0.34942164457979624 -1.8935763502158398 -0.6325563176821224 NA NA</attr>
            </taxon>
            <taxon id="taxon_16">
                <attr name="factors">-0.8161262390971513 -0.6230781939110783 -0.4456292313690999</attr>
                <attr name="traits">2.300332409879507 -1.1865786532505138 -0.20560024628492068 1.3710415643252687
                    0.37780528147873366 -0.9037082410134097
                </attr>
                <attr name="factors2">0.934955457900148 0.73212543842529 -0.5711454771973</attr>
                <attr name="traits2">-0.9407953600719968 0.20093590646835074 -0.5670979818747811 -1.7337551994192786
                    -0.5995189410545666 0.5332496241742802
                </attr>
            </taxon>
            <taxon id="taxon_17">
                <attr name="factors">-1.0144436604293505 1.478607059857378 -0.6908795858187</attr>
                <attr name="traits">-2.3900164996797697 NA -1.27266097686219 -1.6641744157778198 1.3218772342891496
                    3.639739152464377
                </attr>
                <attr name="factors2">1.02275221069095 1.7028612291142875 -1.9605857513657532</attr>
                <attr name="traits2">-2.0241255989792486 NA -1.059606585292308 0.2962825104489853 0.2717043320216292
                    -2.2440491037114514
                </attr>
            </taxon>
            <taxon id="taxon_18">
                <attr name="factors">1.056873733132347 1.1873505039550996 1.066150616149452</attr>
                <attr name="traits">-4.741021089331722 2.7334348360574556 -3.425732392281707 -3.245630095163677 NA
                    -1.0398483118192028
                </attr>
                <attr name="factors2">0.8819363940904343 1.309748664652013 -0.15185628853771327</attr>
                <attr name="traits2">0.31264802326118707 1.08075219284944 -0.0741492631166799 -0.785751053817025 NA
                    0.7101052243517899
                </attr>
            </taxon>
            <taxon id="taxon_19">
                <attr name="factors">-0.2221684856569227 0.41571346596533654 0.10898633050895852</attr>
                <attr name="traits">-1.7590141534663633 1.700159530679466 -1.1222330860200174 -1.9725089485759364
                    -0.0034474695593829513 0.8864456543432668
                </attr>
                <attr name="factors2">0.608734719329516 -0.7359420461875775 0.6540950962355229</attr>
                <attr name="traits2">0.5150091671235774 -1.3680772995699344 0.8041697215406823 0.4749217262040388
                    -2.3258826838462836 -0.5377523342088854
                </attr>
            </taxon>
            <taxon id="taxon_20">
                <attr name="factors">-0.17438164408909365 -0.44738267923159963 0.23315524522158199</attr>
                <attr name="traits">0.699825235901709 -1.0273030546022055 0.0907239153037932 0.7087459046154488
                    1.018207622643108 0.08337659484405302
                </attr>
                <attr name="factors2">-0.7742220679993217 0.6703690576290524 2.1639793658561226</attr>
                <attr name="traits2">1.5306753164709703 -0.32634538196221996 -1.09940921171389 0.6994853382044979
                    1.8869428321199109 0.4977991912544602
                </attr>
            </taxon>
        </taxa>
    </taxa>
    <newick id="startingTree" usingHeights="true" usingDates="false">
        (((((taxon_1:0.34769126656992577,taxon_13:0.34769126656992577):0.38875916604224636,((taxon_3:0.5007872109882292,((taxon_6:0.003931676764071745,taxon_18:0.003931676764071579):0.2875857461700743,taxon_15:0.29151742293414595):0.20926978805408314):0.1454502295470716,taxon_9:0.6462374405353007):0.0902129920768714):0.18585872649337928,taxon_5:0.9223091591055514):0.06582215481694292,((taxon_7:0.2362964387491202,taxon_8:0.2362964387491202):0.5826806291497661,taxon_19:0.8189770678988864):0.16915424602360798):0.01186868607750566,((taxon_2:0.547275897884007,((((taxon_10:0.3910596013771078,taxon_16:0.3910596013771077):0.01617059432106932,taxon_17:0.4072301956981771):0.019508384542838896,taxon_12:0.42673858024101596):0.0823508576929864,taxon_11:0.5090894379340024):0.038186459950004595):0.23663811228161777,(taxon_4:0.269355054484828,(taxon_14:0.18966872798342788,taxon_20:0.18966872798342793):0.07968632650140012):0.5145589556807968):0.21608598983437521);;
    </newick>
    <treeModel id="treeModel" fixHeights="true">
        <tree idref="startingTree"/>
        <rootHeight>
            <parameter id="treeModel.rootHeight"/>
        </rootHeight>
        <nodeHeights internalNodes="true">
            <parameter id="treeModel.internalNodeHeights"/>
        </nodeHeights>
        <nodeHeights internalNodes="true" rootNode="true">
            <parameter id="treeModel.allInternalNodeHeights"/>
        </nodeHeights>
        <nodeTraits rootNode="false" internalNodes="false" leafNodes="true" asMatrix="true" traitDimension="6"
                    name="traits">
            <parameter id="leafTraits"/>
        </nodeTraits>
        <nodeTraits rootNode="false" internalNodes="false" leafNodes="true" asMatrix="true" traitDimension="6"
                    name="traits">
            <parameter id="leafTraits2"/>
        </nodeTraits>
        <nodeTraits rootNode="false" internalNodes="false" leafNodes="true" asMatrix="true" traitDimension="3"
                    name="traits">
            <parameter id="leafFactors2"/>
        </nodeTraits>
    </treeModel>
    <multivariateDiffusionModel id="diffusionModel">
        <precisionMatrix>
            <DiagonalMatrix>
                <parameter value="1.0 1.0 1.0"/>
            </DiagonalMatrix>
        </precisionMatrix>
    </multivariateDiffusionModel>
    <multivariateTraitLikelihood allowIdentical="true" standardize="false" cacheBranches="true"
                                 integrateInternalTraits="true" id="traitLikelihood" traitName="factors"
                                 useTreeLength="false" scaleByTime="true" reportAsMultivariate="true">
        <multivariateDiffusionModel idref="diffusionModel"/>
        <treeModel idref="treeModel"/>
        <traitParameter>
            <parameter id="traitParameter"/>
        </traitParameter>
        <conjugateRootPrior>
            <meanParameter>
                <parameter value="0.0 0.0 0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="0.001"/>
            </priorSampleSize>
        </conjugateRootPrior>
    </multivariateTraitLikelihood>
    <matrixParameter id="U">
        <parameter
                value="0.5893497924703764 -0.3737282683902864 0.3931348972000845 0.4306330259647653 0.07385809584132277 -0.40931544651005347"/>
        <parameter
                value="-0.5616827372460962 -0.1192259436057472 0.20295508122952152 -0.022864109242185137 -0.49602422640258836 -0.6185015047551992"/>
        <parameter
                value="-0.13859872571851461 -0.6032143844715264 0.326588432215581 0.021397341163363268 -0.34494133435568153 0.6251563205973932"/>
    </matrixParameter>
    <parameter id="scale" value="1 1 1"/>

    <scaledMatrixParameter id="L">
        <scale>
            <parameter idref="scale"/>
        </scale>
        <matrix>
            <parameter idref="U"/>
        </matrix>
    </scaledMatrixParameter>

    <independentNormalDistributionModel id="L.prior">
        <data>
            <matrixParameter idref="scale"/>
        </data>
        <mean>
            <parameter
                    value="-1.2823400033912142 2.1809090222419747 0.06721844474197673"/>
        </mean>
        <variance>
            <parameter
                    value="2.9019349189797334 2.4044427895596807 6.544751388765034"/>
        </variance>
    </independentNormalDistributionModel>

    <latentFactorModel id="latentFactorModel" factorNumber="3" traitName="traits" scaleData="false">
        <factors>
            <parameter idref="traitParameter"/>
        </factors>
        <data>
            <dataAndMissingFromTreeTips traitName="traits">
                <treeModel idref="treeModel"/>
                <traitParameter>
                    <parameter idref="leafTraits"/>
                </traitParameter>
            </dataAndMissingFromTreeTips>
        </data>
        <treeModel idref="treeModel"/>
        <loadings>
            <matrixParameter idref="L"/>
        </loadings>
        <rowPrecision>
            <DiagonalMatrix>
                <parameter value="1" dimension="6"/>
            </DiagonalMatrix>
        </rowPrecision>
        <columnPrecision>
            <DiagonalMatrix>
                <parameter id="factorPrecision"
                           value="5.303946837041417 6.102849481866849 0.6288334214918883 0.4712883673025561 1.1687294260119294 1.037762993437785"/>
            </DiagonalMatrix>
        </columnPrecision>

    </latentFactorModel>
    <gammaPrior id="factorPrecision.prior" scale="1.0" shape="1.0">
        <parameter idref="factorPrecision"/>
    </gammaPrior>

    <loadingsScaleGibbsOperator id="scaleOp" weight="1.0">
        <latentFactorModel idref="latentFactorModel"/>
        <distributionLikelihood idref="L.prior"/>
    </loadingsScaleGibbsOperator>

    <cachedReport id="report1">
        <loadingsScaleGibbsOperator idref="scaleOp"/>
    </cachedReport>

    <report>
        <cachedReport idref="report1"/>
    </report>

    <assertEqual tolerance="1e-10" toleranceType="absolute" verbose="true" charactersToStrip="\[\],">
        <message>
            Check loadings scale mean
        </message>
        <actual regex="Scale mean:\s+(.*)\n">
            <cachedReport idref="report1"/>
        </actual>
        <expected>
            -2.8513539883315997 0.9331777667921267 0.19974369003631776
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-10" toleranceType="absolute" verbose="true" charactersToStrip="{},">
        <message>
            Check loadings scale covariance
        </message>
        <actual regex="(?s)Scale covariance:\s+(.*?)\n\n">
            <cachedReport idref="report1"/>
        </actual>
        <expected>
            0.02835759849008684 0.001846353627111521 -0.001156608082633655
            0.001846353627111521 0.03578572009876195 0.00032470622148408684
            -0.0011566080826336553 0.0003247062214840869 0.030187350570008226
        </expected>
    </assertEqual>

    <operators id="operators">

        <fireParameterChanged weight="1"
                              value="0.5316035442433725 5.931640943201586 7.009563781539596 3.7894370437617666 0.846930008489684 0.2782617108181909">
            <parameter idref="factorPrecision"/>
        </fireParameterChanged>

        <fireParameterChanged weight="1">
            <parameter idref="traitParameter"/>
            <copyFrom>
                <dataFromTreeTips traitName="factors2">
                    <treeModel idref="treeModel"/>
                    <traitParameter>
                        <parameter idref="leafFactors2"/>
                    </traitParameter>
                </dataFromTreeTips>
            </copyFrom>
        </fireParameterChanged>

        <fireParameterChanged weight="1">
            <parameter idref="leafTraits"/>
            <copyFrom>
                <dataFromTreeTips traitName="traits2">
                    <treeModel idref="treeModel"/>
                    <traitParameter>
                        <parameter idref="leafTraits2"/>
                    </traitParameter>
                </dataFromTreeTips>
            </copyFrom>
        </fireParameterChanged>

        <fireParameterChanged weight="1"
                              value="0.20956781199950203 0.11664527607617502 0.335057288933828 -1.0803414235418347 1.2358808984285405 -0.19249978477171675
                                    0.49730948900832006 0.7556042225334672 0.8769426427984647 0.05984407853281771 -0.2344683483229183 0.04248585714628226
                                    -0.20898424401458868 -1.5267597472928933 -1.3090333377056513 1.7116708610850269 0.272951846601472 1.4673190222185502">
            <parameter idref="U"/>
        </fireParameterChanged>

        <!--        <randomWalkOperator weight="1" windowSize="1.0">-->
        <!--            <parameter idref="scale"/>-->
        <!--        </randomWalkOperator>-->
    </operators>
    <mcmc id="mcmc" chainLength="10" autoOptimize="true">
        <posterior id="posterior">
            <prior id="prior">
                <distributionLikelihood idref="L.prior"/>
                <gammaPrior idref="factorPrecision.prior"/>
            </prior>
            <likelihood id="likelihood">
                <multivariateTraitLikelihood idref="traitLikelihood"/>
                <latentFactorModel idref="latentFactorModel"/>
            </likelihood>
        </posterior>
        <operators idref="operators"/>
        <log id="screenLog" logEvery="1000">
            <column label="posterior" dp="4" width="12">
                <posterior idref="posterior"/>
            </column>
            <column label="prior" dp="4" width="12">
                <prior idref="prior"/>
            </column>
            <column label="likelihood" dp="4" width="12">
                <likelihood idref="likelihood"/>
            </column>
        </log>
        <log id="fileLog" logEvery="1" fileName="testNewLoadingsGibbsOperator.log" overwrite="true">
            <posterior idref="posterior"/>
            <prior idref="prior"/>
            <likelihood idref="likelihood"/>
            <parameter idref="scale"/>
            <parameter idref="factorPrecision"/>
        </log>
    </mcmc>

    <cachedReport id="report2">
        <loadingsScaleGibbsOperator idref="scaleOp"/>
    </cachedReport>

    <report>
        <cachedReport idref="report2"/>
    </report>

    <assertEqual tolerance="1e-10" toleranceType="absolute" verbose="true" charactersToStrip="\[\],">
        <message>
            Check loadings scale mean
        </message>
        <actual regex="Scale mean:\s+(.*)\n">
            <cachedReport idref="report2"/>
        </actual>
        <expected>
            0.09760673186611324 -0.10209394081867444 -0.026257904744650246
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-10" toleranceType="absolute" verbose="true" charactersToStrip="{},">
        <message>
            Check loadings scale covariance
        </message>
        <actual regex="(?s)Scale covariance:\s+(.*?)\n\n">
            <cachedReport idref="report2"/>
        </actual>
        <expected>
            0.014670831533820284 0.0009101366728414596 -0.0012889639297161846
            0.0009101366728414597 0.006561365723542238 -0.0009725331615566055
            -0.0012889639297161846 -0.0009725331615566055 0.0013728436986310648
        </expected>
    </assertEqual>
</beast>
