<?xml version="1.0" standalone="yes"?>
<beast>

	<taxa id="taxa">
		<taxon id="A">
			<attr name="X">NA NA</attr>
		</taxon>
		<taxon id="B">
			<attr name="X">2 NA</attr>
		</taxon>
		<taxon id="C">
			<attr name="X">3 4</attr>
		</taxon>
	</taxa>

	<newick id="tree">
		((A:1.1,B:1.1):1,C:2.1);
	</newick>

	<treeModel id="treeModel">
		<newick idref="tree"/>
		<rootHeight>
			<parameter id="treeModel.rootHeight"/>
		</rootHeight>
		<nodeHeights internalNodes="true">
			<parameter id="treeModel.internalNodeHeights"/>
		</nodeHeights>
		<nodeHeights internalNodes="true" rootNode="true">
			<parameter id="treeModel.allInternalNodeHeights"/>
		</nodeHeights>
		<nodeTraits name="X" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="2">
			<parameter id="leafTraits"/>
		</nodeTraits>
	</treeModel>

    <multivariateDiffusionModel id="diffusionModel">
        <precisionMatrix>
                <compoundSymmetricMatrix id="precision.matrix" asCorrelation="true" isCholesky="true">
                    <diagonal>
                        <parameter id="precision.diagonal" value="1 1" lower="0 0"/>
                    </diagonal>
                    <offDiagonal>
                        <parameter id="precision.offDiagonal" value="0"/>
                    </offDiagonal>
                </compoundSymmetricMatrix>
        </precisionMatrix>
	</multivariateDiffusionModel>

    <LKJCorrelationPrior id="precision.offDiagonal.prior" shapeParameter="1.0" dimension="2">
		<data>
            <parameter idref="precision.offDiagonal"/>
		</data>
	</LKJCorrelationPrior>

	<traitDataLikelihood id="ibmLikelihood" traitName="X" forceFullPrecision="true" integratedProcess="true">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
		<!-- 
		<driftModels>
			<strictClockBranchRates>
				<rate>
					<parameter id="rate.1" value="-1.4"/>
				</rate>
			</strictClockBranchRates>
			<strictClockBranchRates>
				<rate>
					<parameter id="rate.2" value="1.0"/>
				</rate>
			</strictClockBranchRates>
		</driftModels>
		-->
     	<conjugateRootPrior>
            <meanParameter>
                <parameter id="meanRoot"  value="0 0 0 0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter id="sampleSizeRoot" value="0.00001"/>
            </priorSampleSize>
        </conjugateRootPrior>
	</traitDataLikelihood>

	<report>
		With BM likelihood =
		<traitDataLikelihood idref="ibmLikelihood"/>
	</report>

	<operators id="ibmOperators">
       <randomWalkOperator windowSize="0.1" weight="20" boundaryCondition="log">
           <parameter idref="precision.diagonal"/>
       </randomWalkOperator>
       <randomWalkOperator windowSize="0.1" weight="20">
           <parameter idref="precision.offDiagonal"/>
           <LKJTransform dimension="2"/>
       </randomWalkOperator>
	</operators>

	<mcmc id="ibmMcmc" chainLength="1000000">
		<posterior id="ibmPosterior">
		<prior id="prior">
				<LKJCorrelationPrior idref="precision.offDiagonal.prior"/>
                <halfTPrior id="precision.diagonal.prior" df="1" scale="2.5">
                    <parameter idref="precision.diagonal"/>
                </halfTPrior>
			</prior>
			<likelihood id="likelihood">
				<traitDataLikelihood idref="ibmLikelihood"/>
			</likelihood>
		</posterior>
		<operators idref="ibmOperators"/>
		<log logEvery="10000">
			<posterior idref="ibmPosterior"/>
		</log>

		<log logEvery="1000" fileName="testIBM.log">
			<!-- <traitLogger traitName="X" nodes="all"> -->
			<!-- 	<traitDataLikelihood idref="ibmLikelihood"/> -->
			<!-- 	<treeModel idref="treeModel"/> -->
			<!-- </traitLogger> -->
<!-- 
			<parameter idref="rate.1"/>
			<parameter idref="rate.2"/>
 -->
			<traitDataLikelihood idref="ibmLikelihood"/>
			<parameter idref="meanRoot"/>
			<parameter idref="sampleSizeRoot"/>
			<matrixParameter idref="precision.matrix"/>
            <matrixParameter idref="precision.diagonal"/>
            <matrixParameter idref="precision.offDiagonal"/>
		</log>

		<!-- <logTree logEvery="1" nexusFormat="true" fileName="testIBM.trees"> -->
		<!-- 	<traitDataLikelihood idref="ibmLikelihood"/> -->
		<!-- 	<treeModel idref="treeModel"/> -->
		<!-- </logTree> -->
	</mcmc>

</beast>

