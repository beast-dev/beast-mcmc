<?xml version="1.0" standalone="yes"?>

<!-- Generated by BEAUTi v1.10.5 Prerelease #23570d1                         -->
<!--       by Alexei J. Drummond, Andrew Rambaut and Marc A. Suchard         -->
<!--       Department of Computer Science, University of Auckland and        -->
<!--       Institute of Evolutionary Biology, University of Edinburgh        -->
<!--       David Geffen School of Medicine, University of California, Los Angeles-->
<!--       http://beast.community/                                           -->

<beast version="1.10.5">

    <taxa id="taxa">
        <taxon id="A"/>
        <taxon id="B"/>
        <taxon id="C"/>
        <taxon id="D"/>
    </taxa>


    <newick id="startingTree" usingHeights="true" usingDates="false">
        ((A:1.0,B:2.0):1.0,(C:1.0,D:2.0):2.0)
    </newick>


    <!-- Generate a tree model                                                   -->
    <treeModel id="treeModel">
        <newick idref="startingTree"/>
        <rootHeight>
            <parameter id="treeModel.rootHeight"/>
        </rootHeight>
        <nodeHeights internalNodes="true">
            <parameter id="treeModel.internalNodeHeights"/>
        </nodeHeights>
        <nodeHeights internalNodes="true" rootNode="true">
            <parameter id="treeModel.allInternalNodeHeights"/>
        </nodeHeights>
    </treeModel>

    <compoundParameter id="birthRate.increments">
        <parameter id="birthRateAtPresent" value="-2.0"/>
        <parameter id="birthRateDelta" dimension="54" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.birthRate" dim="55" incrementTransformType="log">
        <compoundParameter idref="birthRate.increments"/>
    </transformedVectorSumTransform>

    <compoundParameter id="deathRate.increments">
        <parameter id="deathRateAtPresent" value="-2.0"/>
        <parameter id="deathRateDelta" dimension="54" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.deathRate" dim="55" incrementTransformType="log">
        <compoundParameter idref="deathRate.increments"/>
    </transformedVectorSumTransform>

    <compoundParameter id="samplingRate.increments">
        <parameter id="samplingRateAtPresent" value="-2.0"/>
        <parameter id="samplingRateDelta" dimension="54" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.samplingRate" dim="55" incrementTransformType="logit" lower="0.0" upper="0.587405">
        <compoundParameter idref="samplingRate.increments"/>
    </transformedVectorSumTransform>

    <compoundParameter id="treatmentProbability.increments">
        <parameter id="treatmentProbabilityAtPresent" value="-2.0"/>
        <parameter id="treatmentProbabilityDelta" dimension="54" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.treatmentProbability" dim="55" incrementTransformType="logit" lower="0.0" upper="1.0">
        <compoundParameter idref="treatmentProbability.increments"/>
    </transformedVectorSumTransform>

    <newBirthDeathSerialSampling id="bdss" units="years" hasFinalSample="false" conditionOnSurvival="false">
        <birthRate>
            <parameter idref="bdss.birthRate"/>
        </birthRate>
        <deathRate>
            <parameter idref="bdss.deathRate"/>
        </deathRate>
        <samplingRate>
            <parameter idref="bdss.samplingRate"/>
        </samplingRate>
        <samplingProbability>
            <compoundParameter id="bdss.samplingProbability">
                <parameter id="samplingAtPresent" value="1.0" dimension="1" lower="0.0" upper="1.0"/>
                <parameter id="otherSampling" value="0.0" dimension="54" lower="0.0" upper="1.0"/>
            </compoundParameter>
        </samplingProbability>
        <treatmentProbability>
            <parameter idref="bdss.treatmentProbability"/>
        </treatmentProbability>
        <origin>
            <parameter id="bdss.origin" value="55.114793" lower="0.0"/>
        </origin>
        <cutOff>
            <parameter value="55"/>
        </cutOff>
        <numGridPoints>
            <parameter value="55"/>
        </numGridPoints>
    </newBirthDeathSerialSampling>



    <speciationLikelihood id="speciation" useNewLoop="true">
        <model>
            <birthDeathSerialSampling idref="bdss"/>
        </model>
        <speciesTree>
            <treeModel idref="treeModel"/>
        </speciesTree>
    </speciationLikelihood>


    <distributionLikelihood id="birthRateAtPresentPrior">
        <data>
            <parameter idref="birthRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="birthRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="-2.302585"/>
                </mean>
                <stdev>
                    <parameter value="1.0" lower="0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>

    <distributionLikelihood id="deathRateAtPresentPrior">
        <data>
            <parameter idref="deathRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="deathRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="-2.302585"/>
                </mean>
                <stdev>
                    <parameter value="1.0" lower="0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>

    <distributionLikelihood id="samplingRateAtPresentPrior">
        <data>
            <parameter idref="samplingRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="samplingRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="-2.302585"/>
                </mean>
                <stdev>
                    <parameter value="1.0" lower="0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>

    <bayesianBridge id="birthRateDeltaPrior">
        <parameter idref="birthRateDelta"/>
        <globalScale>
            <parameter id="birthRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="birthRateDeltaPrior.localScale" value="0.1" dimension="54"/> <!-- keep these fixed for Normal -->
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
            <parameter value="2.0"/>
        </slabWidth>
    </bayesianBridge>

    <bayesianBridge id="deathRateDeltaPrior">
        <parameter idref="deathRateDelta"/>
        <globalScale>
            <parameter id="deathRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="deathRateDeltaPrior.localScale" value="0.1" dimension="54"/> <!-- keep these fixed for Normal -->
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
            <parameter value="2.0"/>
        </slabWidth>
    </bayesianBridge>

    <bayesianBridge id="samplingRateDeltaPrior">
        <parameter idref="samplingRateDelta"/>
        <globalScale>
            <parameter id="samplingRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="samplingRateDeltaPrior.localScale" value="0.1" dimension="54"/> <!-- keep these fixed for Normal -->
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
            <parameter value="2.0"/>
        </slabWidth>
    </bayesianBridge>


    <gammaPrior id="birthRateDeltaGlobalScalePrior" shape="1.0" scale="2.0">
        <parameter idref="birthRateDeltaPrior.globalScale"/>
    </gammaPrior>

    <gammaPrior id="deathRateDeltaGlobalScalePrior" shape="1.0" scale="2.0">
        <parameter idref="deathRateDeltaPrior.globalScale"/>
    </gammaPrior>

    <gammaPrior id="samplingRateDeltaGlobalScalePrior" shape="1.0" scale="2.0">
        <parameter idref="samplingRateDeltaPrior.globalScale"/>
    </gammaPrior>

    <compoundGradient id="grad.bdss.prior">
        <numericalHessian>
            <compoundGradient>
                <gradient>
                    <multivariateDistributionLikelihood idref="birthRateAtPresentPrior"/>
                    <parameter idref="birthRateAtPresent"/>
                </gradient>
                <bayesianBridge idref="birthRateDeltaPrior"/>
            </compoundGradient>
        </numericalHessian>
        <numericalHessian>
            <compoundGradient>
                <gradient>
                    <multivariateDistributionLikelihood idref="deathRateAtPresentPrior"/>
                    <parameter idref="deathRateAtPresent"/>
                </gradient>
                <bayesianBridge idref="deathRateDeltaPrior"/>
            </compoundGradient>
        </numericalHessian>
        <numericalHessian>
            <compoundGradient>
                <gradient>
                    <multivariateDistributionLikelihood idref="samplingRateAtPresentPrior"/>
                    <parameter idref="samplingRateAtPresent"/>
                </gradient>
                <bayesianBridge idref="samplingRateDeltaPrior"/>
            </compoundGradient>
        </numericalHessian>
    </compoundGradient>

    <compoundGradient id="grad.bdssIncrements.likelihood">
        <gradientWrtIncrements1D id="grad.birthRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="birthRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="birthRate.increments"/>
        </gradientWrtIncrements1D>
        <gradientWrtIncrements1D id="grad.deathRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="deathRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="deathRate.increments"/>
        </gradientWrtIncrements1D>
        <gradientWrtIncrements1D id="grad.samplingRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="samplingRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="samplingRate.increments"/>
        </gradientWrtIncrements1D>
    </compoundGradient>

    <cachedReport id="birthRateReport">
        <gradientWrtIncrements1D incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="birthRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="birthRate.increments"/>
        </gradientWrtIncrements1D>
    </cachedReport>

    <cachedReport id="deathRateReport">
        <gradientWrtIncrements1D incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="deathRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="deathRate.increments"/>
        </gradientWrtIncrements1D>
    </cachedReport>

    <cachedReport id="samplingRateReport">
        <gradientWrtIncrements1D incrementTransformType="logit" lower="0.0" upper="0.587405">
            <speciationLikelihoodGradient wrtParameter="samplingRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="samplingRate.increments"/>
        </gradientWrtIncrements1D>
    </cachedReport>

<!--    // TODO: numerical and analytical gradients not equal!-->
<!--    <cachedReport id="treatmentProbabilityReport">-->
<!--        <gradientWrtIncrements1D incrementTransformType="log">-->
<!--            <speciationLikelihoodGradient wrtParameter="treatmentProbability" useNewLoop="true">-->
<!--                <speciationLikelihood idref="speciation"/>-->
<!--                <treeModel idref="treeModel"/>-->
<!--            </speciationLikelihoodGradient>-->
<!--            <compoundParameter idref="treatmentProbability.increments"/>-->
<!--        </gradientWrtIncrements1D>-->
<!--    </cachedReport>-->

<!--    <report>-->
<!--        <cachedReport idref="birthRateReport"/>-->
<!--    </report>-->

<!--    <report>-->
<!--        <cachedReport idref="deathRateReport"/>-->
<!--    </report>-->

<!--    <report>-->
<!--        <cachedReport idref="samplingRateReport"/>-->
<!--    </report>-->

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check birth rate
        </message>
        <actual regex="Gradient WRT increments:\s(.*?)\n">
            <cachedReport idref="birthRateReport"/>
        </actual>
        <expected  regex="Numerical gradient:\s(.*?)\n">
            <cachedReport idref="birthRateReport"/>
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check death rate
        </message>
        <actual regex="Gradient WRT increments:\s(.*?)\n">
            <cachedReport idref="deathRateReport"/>
        </actual>
        <expected  regex="Numerical gradient:\s(.*?)\n">
            <cachedReport idref="deathRateReport"/>
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check sampling rate
        </message>
        <actual regex="Gradient WRT increments:\s(.*?)\n">
            <cachedReport idref="samplingRateReport"/>
        </actual>
        <expected  regex="Numerical gradient:\s(.*?)\n">
            <cachedReport idref="samplingRateReport"/>
        </expected>
    </assertEqual>

<!--    <report>-->
<!--        <maximizeWrtParameter id="maximizer" printToScreen="true">-->
<!--            <jointGradient>-->
<!--                <compoundGradient idref="grad.bdssIncrements.likelihood"/>-->
<!--                &lt;!&ndash;            <compoundGradient idref="numerical.grad"/>&ndash;&gt;-->
<!--                <compoundGradient idref="grad.bdss.prior"/>-->
<!--            </jointGradient>-->
<!--        </maximizeWrtParameter>-->
<!--    </report>-->

</beast>