<?xml version="1.0" standalone="yes"?>

<!-- Generated by BEAUTi v1.10.5 Prerelease #23570d1                         -->
<!--       by Alexei J. Drummond, Andrew Rambaut and Marc A. Suchard         -->
<!--       Department of Computer Science, University of Auckland and        -->
<!--       Institute of Evolutionary Biology, University of Edinburgh        -->
<!--       David Geffen School of Medicine, University of California, Los Angeles-->
<!--       http://beast.community/                                           -->
<beast version="1.10.5">


    <!-- The list of taxa to be analysed (can also include dates/ages).          -->
    <!-- ntax=7                                                                  -->
    <taxa id="taxa">
        <taxon id="A"/>
        <taxon id="B"/>
        <taxon id="C"/>
        <taxon id="D"/>
    </taxa>

    <taxa id="theClade">
        <taxon idref="C"/>
        <taxon idref="D"/>
    </taxa>

    <taxa id="directOverlap">
        <taxon idref="B"/>
        <taxon idref="C"/>
        <taxon idref="D"/>
    </taxa>

    <taxa id="indirectOverlap1">
        <taxon idref="B"/>
        <taxon idref="C"/>
    </taxa>

    <taxa id="indirectOverlap2">
        <taxon idref="B"/>
        <taxon idref="D"/>
    </taxa>


    <!-- The sequence alignment (each sequence refers to a taxon above).         -->
    <alignment id="alignment2" dataType="nucleotide">
        <sequence>
            <taxon idref="A"/>
            AAACCCGGTAACAA
        </sequence>
        <sequence>
            <taxon idref="B"/>
            AAACCTGGGAATAA
        </sequence>
        <sequence>
            <taxon idref="C"/>
            AAACTCGGGAATGA
        </sequence>
        <sequence>
            <taxon idref="D"/>
            ATACCCGGTGGTAG
        </sequence>
    </alignment>

    <patterns id="patterns2" from="1" strip="false">
        <alignment idref="alignment2"/>
    </patterns>

    <!-- A prior assumption that the population size has remained constant       -->
    <!-- throughout the time spanned by the genealogy.                           -->
    <constantSize id="constant" units="years">
        <populationSize>
            <parameter id="constant.popSize" value="1.0" lower="0.0"/>
        </populationSize>
    </constantSize>


    <!-- Generate a random starting tree under the coalescent process            -->
    <newick id="startingTree" usingHeights="true" usingDates="false">
        (A:1.0,(B:1.0,(C:1.0,D:1.0):1.0):1.0);
    </newick>


    <!-- Generate a tree model                                                   -->
    <treeModel id="treeModel">
        <newickTree idref="startingTree"/>
        <rootHeight>
            <parameter id="treeModel.rootHeight"/>
        </rootHeight>
        <nodeHeights internalNodes="true">
            <parameter id="treeModel.internalNodeHeights"/>
        </nodeHeights>
        <nodeHeights internalNodes="true" rootNode="true">
            <parameter id="treeModel.allInternalNodeHeights"/>
        </nodeHeights>
    </treeModel>

    <!-- Statistic for sum of the branch lengths of the tree (tree length)       -->
    <treeLengthStatistic id="treeLength">
        <treeModel idref="treeModel"/>
    </treeLengthStatistic>


    <!-- Generate a coalescent likelihood                                        -->
    <coalescentLikelihood id="coalescent">
        <model>
            <constantSize idref="constant"/>
        </model>
        <populationTree>
            <treeModel idref="treeModel"/>
        </populationTree>
    </coalescentLikelihood>


    <!-- The strict clock (Uniform rates across branches)                        -->
    <strictClockBranchRates id="branchRates">
        <rate>
            <parameter id="clock.rate" value="0.1"/>
        </rate>
    </strictClockBranchRates>

    <rateStatistic id="meanRate" name="meanRate" mode="mean" internal="true" external="true">
        <treeModel idref="treeModel"/>
        <strictClockBranchRates idref="branchRates"/>
    </rateStatistic>

    <gtrModel id="gtr1">
        <frequencies>
            <frequencyModel dataType="nucleotide">
                <frequencies>
                    <parameter id="gtr1.frequencies" value="0.1 0.2 0.3 0.4"/>
                </frequencies>
            </frequencyModel>
        </frequencies>
        <rates>
            <parameter id="gtr1.rates" dimension="6" value="1.0 2.0 1.0 1.0 2.0 1.0" lower="0.0"/>
        </rates>
    </gtrModel>

    <gtrModel id="gtr2">
        <frequencies>
            <frequencyModel dataType="nucleotide">
                <frequencies>
                    <parameter id="gtr2.frequencies" value="0.4 0.3 0.2 0.1"/>
                </frequencies>
            </frequencyModel>
        </frequencies>
        <rates>
            <parameter id="gtr2.rates" dimension="6" value="1.0 25.0 1.0 1.0 25.0 1.0" lower="0.0"/>
        </rates>
    </gtrModel>

    <estimableStemWeightBranchSpecificSubstitutionModel id="cladeDependentSubstitutionModel1" dataType="nucleotide">
        <treeModel idref="treeModel"/>
        <!-- The model for all taxa not in the specific clade -->
        <gtrModel idref="gtr1"/>
        <!-- Second substitution model and defining clade -->
        <clade>
            <stemWeight>
                <parameter value="0.0" lower="0.0" upper="1.0"/>
            </stemWeight>
            <taxa idref="theClade"/>
            <gtrModel idref="gtr2"/>
        </clade>
    </estimableStemWeightBranchSpecificSubstitutionModel>

    <estimableStemWeightBranchSpecificSubstitutionModel id="cladeDependentSubstitutionModel2" dataType="nucleotide">
        <treeModel idref="treeModel"/>
        <!-- The model for all taxa not in the specific clade -->
        <gtrModel idref="gtr1"/>
        <!-- Second substitution model and defining clade -->
        <clade>
            <stemWeight>
                <parameter value="0.5" lower="0.0" upper="1.0"/>
            </stemWeight>
            <taxa idref="theClade"/>
            <gtrModel idref="gtr2"/>
        </clade>
    </estimableStemWeightBranchSpecificSubstitutionModel>

    <estimableStemWeightBranchSpecificSubstitutionModel id="cladeDependentSubstitutionModel3" dataType="nucleotide">
        <treeModel idref="treeModel"/>
        <!-- The model for all taxa not in the specific clade -->
        <gtrModel idref="gtr1"/>
        <!-- Second substitution model and defining clade -->
        <clade>
            <stemWeight>
                <parameter value="1.0" lower="0.0" upper="1.0"/>
            </stemWeight>
            <taxa idref="theClade"/>
            <gtrModel idref="gtr2"/>
        </clade>
    </estimableStemWeightBranchSpecificSubstitutionModel>

    <estimableStemWeightBranchSpecificSubstitutionModel id="cladeDependentSubstitutionModel4" dataType="nucleotide">
        <treeModel idref="treeModel"/>
        <!-- The model for all taxa not in the specific clade -->
        <gtrModel idref="gtr1"/>
        <!-- Second substitution model and defining clade -->
        <clade>
            <stemWeight>
                <parameter id="stemProportionParameter" value="0.707" lower="0.0" upper="1.0"/>
            </stemWeight>
            <taxa idref="theClade"/>
            <gtrModel idref="gtr2"/>
        </clade>
    </estimableStemWeightBranchSpecificSubstitutionModel>

    <!-- site model                                                              -->
    <siteModel id="siteModel1">
        <!-- <substitutionModel> -->
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel1"/>
        <!-- </substitutionModel> -->
    </siteModel>

    <!-- site model                                                              -->
    <siteModel id="siteModel2">
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel2"/>
    </siteModel>

    <!-- site model                                                              -->
    <siteModel id="siteModel3">
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel3"/>
    </siteModel>

    <!-- site model                                                              -->
    <siteModel id="siteModel4">
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel4"/>
    </siteModel>

    <treeDataLikelihood id="treeLikelihood1" useAmbiguities="false">
        <patterns idref="patterns2"/>
        <treeModel idref="treeModel"/>
        <siteModel idref="siteModel1"/>
        <strictClockBranchRates idref="branchRates"/>
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel1"/>
    </treeDataLikelihood>

    <treeDataLikelihood id="treeLikelihood2" useAmbiguities="false">
        <patterns idref="patterns2"/>
        <treeModel idref="treeModel"/>
        <siteModel idref="siteModel2"/>
        <strictClockBranchRates idref="branchRates"/>
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel2"/>
    </treeDataLikelihood>

    <treeDataLikelihood id="treeLikelihood3" useAmbiguities="false">
        <patterns idref="patterns2"/>
        <treeModel idref="treeModel"/>
        <siteModel idref="siteModel3"/>
        <strictClockBranchRates idref="branchRates"/>
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel3"/>
    </treeDataLikelihood>

    <treeDataLikelihood id="treeLikelihood4" useAmbiguities="false">
        <patterns idref="patterns2"/>
        <treeModel idref="treeModel"/>
        <siteModel idref="siteModel4"/>
        <strictClockBranchRates idref="branchRates"/>
        <branchSpecificSubstitutionModel idref="cladeDependentSubstitutionModel4"/>
    </treeDataLikelihood>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check stem weight 0.0
        </message>
        <actual regex="dr.evomodel.treedatalikelihood.TreeDataLikelihood\((.*?)\)">
            <cachedReport>
                <treeDataLikelihood idref="treeLikelihood1"/>
            </cachedReport>
        </actual>
        <expected>
            -65.9680135693
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check stem weight 1.0
        </message>
        <actual regex="dr.evomodel.treedatalikelihood.TreeDataLikelihood\((.*?)\)">
            <cachedReport>
                <treeDataLikelihood idref="treeLikelihood3"/>
            </cachedReport>
        </actual>
        <expected>
            -65.8150236001
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check stem weight 0.5
        </message>
        <actual regex="dr.evomodel.treedatalikelihood.TreeDataLikelihood\((.*?)\)">
            <cachedReport>
                <treeDataLikelihood idref="treeLikelihood2"/>
            </cachedReport>
        </actual>
        <expected>
            -65.8929018739
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-6" verbose="true" charactersToStrip="\[\],">
        <message>
            check stem weight 0.707
        </message>
        <actual regex="dr.evomodel.treedatalikelihood.TreeDataLikelihood\((.*?)\)">
            <cachedReport>
                <treeDataLikelihood idref="treeLikelihood4"/>
            </cachedReport>
        </actual>
        <expected>
            -65.8612061872
        </expected>
    </assertEqual>

    <!--  This will throw an error about incompatible clades  -->
<!--    <estimableStemWeightBranchSpecificSubstitutionModel id="cladeDependentSubstitutionModel5" dataType="nucleotide">-->
<!--        <treeModel idref="treeModel"/>-->
<!--        &lt;!&ndash; The model for all taxa not in the specific clade &ndash;&gt;-->
<!--        <gtrModel idref="gtr1"/>-->
<!--        &lt;!&ndash; Second substitution model and defining clade &ndash;&gt;-->
<!--        <clade>-->
<!--            <stemWeight>-->
<!--                <parameter id="parameter1" value="0.15" lower="0.0" upper="1.0"/>-->
<!--            </stemWeight>-->
<!--            <taxa idref="theClade"/>-->
<!--            <gtrModel idref="gtr2"/>-->
<!--        </clade>-->
<!--        <clade>-->
<!--            <stemWeight>-->
<!--                <parameter id="parameter2" value="0.16" lower="0.0" upper="1.0"/>-->
<!--            </stemWeight>-->
<!--            <taxa idref="directOverlap"/>-->
<!--            <gtrModel idref="gtr2"/>-->
<!--        </clade>-->
<!--    </estimableStemWeightBranchSpecificSubstitutionModel>-->

</beast>

<!-- R code for computing reference likelihoods -->
<!--        library(phangorn)-->

<!--        assembleQ.gtr <- function(er,bf) {-->
<!--        # recover()-->

<!--        # Ensure exchange rates and "base frequencies" are normalized-->
<!--        bf <- bf/sum(bf)-->
<!--        er <- er/sum(er)-->

<!--        # Assemble Q matrix-->
<!--        Q_ <- matrix(0,4,4)-->
<!--        Q_[1,2] <- Q_[2,1] <- er[1]-->
<!--        Q_[1,3] <- Q_[3,1] <- er[2]-->
<!--        Q_[1,4] <- Q_[4,1] <- er[3]-->
<!--        Q_[2,3] <- Q_[3,2] <- er[4]-->
<!--        Q_[2,4] <- Q_[4,2] <- er[5]-->
<!--        Q_[3,4] <- Q_[4,3] <- er[6]-->

<!--        for (i in 1:4) {-->
<!--        Q_[,i] <- Q_[,i] * bf[i]-->
<!--        }-->
<!--        diag(Q_) <- -rowSums(Q_)-->

<!--        # Normalize-->
<!--        Q_ <- Q_ / (-sum(bf * diag(Q_)))-->

<!--        row.names(Q_) <- colnames(Q_) <- c("A","C","G","T")-->
<!--        return(Q_)-->
<!--        }-->

<!--        computeLnL <- function(stemWeight) {-->
<!--        # recover()-->

<!--        # A fixed tree (A,(B,(C,D)))-->
<!--        # the clade C+D and some proportion of that stem branch get GTR2-->
<!--        # the rest of the tree gets GTR1-->

<!--        phy <- read.tree(text="(A:1.0,(B:1.0,(C:1.0,D:1.0):1.0):1.0);")-->
<!--        phy$edge.length <- 0.1 * phy$edge.length-->

<!--        aln <- do.call(rbind,strsplit(c(-->
<!--        "AAACCCGGTAACAA",-->
<!--        "AAACCTGGGAATAA",-->
<!--        "AAACTCGGGAATGA",-->
<!--        "ATACCCGGTGGTAG"-->
<!--        ),""))-->
<!--        row.names(aln) <- c("A","B","C","D")-->

<!--        nucs <- c("A","C","G","T")-->
<!--        aln <- apply(aln,c(1,2),function(x){-->
<!--        which(nucs == x)-->
<!--        })-->

<!--        Q1 <- assembleQ.gtr(c(1,2,1,1,2,1),(1:4)/10)-->
<!--        Q2 <- assembleQ.gtr(c(1,25,1,1,25,1),(4:1)/10)-->

<!--        root_bf <- (1:4)/10-->

<!--        asrv <- rep(1,4)-->

<!--        likelihood_per_category <- sapply(asrv,function(rate){-->
<!--        non_mixed_brlen <- phy$edge.length[1] * rate-->

<!--        GTR1 <- expm::expm(Q1 * non_mixed_brlen)-->
<!--        GTR2 <- expm::expm(Q2 * non_mixed_brlen)-->
<!--        GTR_mixed <- expm::expm(Q1 * non_mixed_brlen * (1 - stemWeight)) %*% expm::expm(Q2 * non_mixed_brlen * stemWeight)-->

<!--        per_site_L <- sapply(1:dim(aln)[2],function(j) {-->
<!--        # Tip labels are A=1, B=2, C=3, D=4-->
<!--        # We number the root node 5, BCD's common ancestor 6, and CD's common ancestor 7-->
<!--        plv <- matrix(NA,7,4)-->
<!--        plv[1:4,] <- 0-->
<!--        for (i in 1:4) {-->
<!--        plv[i,aln[i,j]] <- 1.0-->
<!--        }-->

<!--        for (i in 1:4) {-->
<!--        plv[7,i] <- sum(GTR2[i,] * plv[3,]) * sum(GTR2[i,] * plv[4,])-->
<!--        }-->

<!--        for (i in 1:4) {-->
<!--        plv[6,i] <- sum(GTR_mixed[i,] * plv[7,]) * sum(GTR1[i,] * plv[2,])-->
<!--        }-->

<!--        for (i in 1:4) {-->
<!--        plv[5,i] <- sum(GTR1[i,] * plv[6,]) * sum(GTR1[i,] * plv[1,])-->
<!--        }-->

<!--        return(sum(root_bf * plv[5,]))-->
<!--        })-->
<!--        })-->

<!--        sum(log(rowSums(likelihood_per_category * 0.25)))-->
<!--        }-->

<!--        sprintf("%.10f",computeLnL(0.0))-->
<!--        sprintf("%.10f",computeLnL(1.0))-->
<!--        sprintf("%.10f",computeLnL(0.5))-->
<!--        sprintf("%.10f",computeLnL(0.707))-->
