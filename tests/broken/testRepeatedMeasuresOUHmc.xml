<?xml version="1.0" standalone="yes"?>
<!-- Generated by BEAUTi v1.5.4                                              -->
<!--       by Alexei J. Drummond and Andrew Rambaut                          -->
<!--       Department of Computer Science, University of Auckland and        -->
<!--       Institute of Evolutionary Biology, University of Edinburgh        -->
<!--       http://beast.bio.ed.ac.uk/                                        -->
<beast>

    <taxa id="taxa">
		<taxon id="t1" > <attr name="simTrait"> 0.5187928 -0.9953032 </attr> </taxon>
		<taxon id="t2" > <attr name="simTrait"> 1.4236142 -0.8579857 </attr> </taxon>
		<taxon id="t3" > <attr name="simTrait"> 0.9708200 -0.6088057 </attr> </taxon>
		<taxon id="t4" > <attr name="simTrait"> 0.7058376 -1.0471825 </attr> </taxon>
		<taxon id="t5" > <attr name="simTrait"> 0.9452878 -1.0680218 </attr> </taxon>
		<taxon id="t6" > <attr name="simTrait"> 0.3892721 -0.5553641 </attr> </taxon>
		<taxon id="t7" > <attr name="simTrait"> 0.9363306 -1.1778173 </attr> </taxon>
		<taxon id="t8" > <attr name="simTrait"> 0.5273544 -0.6415779 </attr> </taxon>
		<taxon id="t9" > <attr name="simTrait"> 0.8227259 -1.0835770 </attr> </taxon>
		<taxon id="t10"> <attr name="simTrait"> 0.6198324 -1.1840022 </attr> </taxon>
		<taxon id="t11"> <attr name="simTrait"> 0.5953019 -1.2327299 </attr> </taxon>
		<taxon id="t12"> <attr name="simTrait"> 0.4812645 -0.7599126 </attr> </taxon>
		<taxon id="t13"> <attr name="simTrait"> 0.8791917 -1.0553573 </attr> </taxon>
		<taxon id="t14"> <attr name="simTrait"> 0.8661834 -1.1159879 </attr> </taxon>
		<taxon id="t15"> <attr name="simTrait"> 1.3419551 -0.7192452 </attr> </taxon>
		<taxon id="t16"> <attr name="simTrait"> 0.2770225 -1.0053403 </attr> </taxon>
		<taxon id="t17"> <attr name="simTrait"> 0.9171756 -0.9647458 </attr> </taxon>
		<taxon id="t18"> <attr name="simTrait"> 0.6636737 -1.1761627 </attr> </taxon>
		<taxon id="t19"> <attr name="simTrait"> 0.7675867 -1.2997873 </attr> </taxon>
		<taxon id="t20"> <attr name="simTrait"> 0.7163961 -1.1276810 </attr> </taxon>
		<taxon id="t21"> <attr name="simTrait"> 1.0037851 -1.0487661 </attr> </taxon>
		<taxon id="t22"> <attr name="simTrait"> 0.5608472 -1.3538073 </attr> </taxon>
		<taxon id="t23"> <attr name="simTrait"> 1.1235197 -1.2338775 </attr> </taxon>
		<taxon id="t24"> <attr name="simTrait"> 1.0428614 -0.5620567 </attr> </taxon>
		<taxon id="t25"> <attr name="simTrait"> 0.9471007 -1.1146408 </attr> </taxon>
		<taxon id="t26"> <attr name="simTrait"> 1.2191037 -0.8717289 </attr> </taxon>
		<taxon id="t27"> <attr name="simTrait"> 0.9457645 -0.8398526 </attr> </taxon>
		<taxon id="t28"> <attr name="simTrait"> 1.1232702 -1.2303039 </attr> </taxon>
		<taxon id="t29"> <attr name="simTrait"> 1.4837278 -0.9829630 </attr> </taxon>
		<taxon id="t30"> <attr name="simTrait"> 0.5414352 -0.6237185 </attr> </taxon>
		<taxon id="t31"> <attr name="simTrait"> 0.7700067 -0.9566955 </attr> </taxon>
		<taxon id="t32"> <attr name="simTrait"> 0.8577741 -0.7556166 </attr> </taxon>
		<taxon id="t33"> <attr name="simTrait"> 0.9175704 -1.1709501 </attr> </taxon>
		<taxon id="t34"> <attr name="simTrait"> 0.4690982 -1.0675392 </attr> </taxon>
		<taxon id="t35"> <attr name="simTrait"> 0.8253025 -1.1093743 </attr> </taxon>
		<taxon id="t36"> <attr name="simTrait"> 0.8282605 -1.0339389 </attr> </taxon>
		<taxon id="t37"> <attr name="simTrait"> 0.5911439 -1.1359221 </attr> </taxon>
		<taxon id="t38"> <attr name="simTrait"> 1.0163024 -1.2480107 </attr> </taxon>
		<taxon id="t39"> <attr name="simTrait"> 0.9745489 -1.2176536 </attr> </taxon>
		<taxon id="t40"> <attr name="simTrait"> 0.6260692 -1.0073364 </attr> </taxon>
		<taxon id="t41"> <attr name="simTrait"> 0.7079400 -1.2162314 </attr> </taxon>
		<taxon id="t42"> <attr name="simTrait"> 0.9542626 -0.6337450 </attr> </taxon>
		<taxon id="t43"> <attr name="simTrait"> 0.6871348 -1.1331718 </attr> </taxon>
		<taxon id="t44"> <attr name="simTrait"> 1.4544156 -0.8886152 </attr> </taxon>
		<taxon id="t45"> <attr name="simTrait"> 0.3562828 -1.1743511 </attr> </taxon>
		<taxon id="t46"> <attr name="simTrait"> 1.0272279 -1.1336090 </attr> </taxon>
		<taxon id="t47"> <attr name="simTrait"> 0.6396380 -0.8450697 </attr> </taxon>
		<taxon id="t48"> <attr name="simTrait"> 0.8329018 -1.0146780 </attr> </taxon>
		<taxon id="t49"> <attr name="simTrait"> 0.7294590 -1.0835114 </attr> </taxon>
		<taxon id="t50"> <attr name="simTrait"> 1.0541616 -1.1611085 </attr> </taxon>
    </taxa>

    <!-- ************************************************** -->
    <!-- Tree -->
    
	<newick id="tree" usingHeights="true" usingDates="false">
		((t21:0.9170744128,((t26:0.04925968301,t15:0.04925968301):0.4807036865,t49:0.5299633695):0.3871110433):0.08292558717,(((((((t24:0.04476422283,t27:0.04476422283):0.0004519817023,t3:0.04521620453):0.1896137708,((t35:0.137577555,(t5:0.09945647134,(t28:0.001685786138,t23:0.001685786138):0.0977706852):0.03812108364):0.01159666826,t38:0.1491742232):0.08565575207):0.006367518279,((t31:0.06289510188,t7:0.06289510188):0.1522877354,(t19:0.1624687102,(t14:0.1135995209,t18:0.1135995209):0.04886918922):0.05271412712):0.0260146563):0.389748176,((((t13:0.1607239139,((t20:0.01692863409,t10:0.01692863409):0.1378092834,(t41:0.04565731458,t36:0.04565731458):0.1090806029):0.005985996464):0.03311320151,(t17:0.174974114,(t25:0.113976468,t32:0.113976468):0.06099764597):0.01886300141):0.2690037908,((((t47:0.14155974,(t37:0.1389101761,(t45:0.04413059476,t34:0.04413059476):0.09477958134):0.002649563931):0.04321437858,(t16:0.177670741,(t12:0.02962759412,(t6:0.01736721441,(t8:0.004809705073,t30:0.004809705073):0.01255750934):0.01226037971):0.1480431469):0.00710337759):0.0001428595688,(t22:0.02133775733,t11:0.02133775733):0.1635792209):0.2660133416,(t50:0.3920081501,t9:0.3920081501):0.05892216971):0.01191058649):0.03028606119,((t4:0.1812050471,(t40:0.139070643,t1:0.139070643):0.04213440411):0.01156150834,(t48:0.10693596,t43:0.10693596):0.08583059551):0.300360412):0.1378187022):0.01536229655,((t33:0.07923165804,(t39:0.01145958107,t46:0.01145958107):0.06777207697):0.3114653894,t42:0.3906970475):0.2556109187):0.1989454968,(t2:0.1040938055,(t44:0.08319498022,t29:0.08319498022):0.02089882524):0.7411596576):0.154746537);
    </newick>

    <treeModel id="treeModel">
        <newick idref="tree"/>
        <rootHeight>
            <parameter id="treeModel.rootHeight"/>
        </rootHeight>
        <nodeHeights internalNodes="true">
            <parameter id="treeModel.internalNodeHeights"/>
        </nodeHeights>
        <nodeHeights internalNodes="true" rootNode="true">
            <parameter id="treeModel.allInternalNodeHeights"/>
        </nodeHeights>
		<nodeTraits name="simTrait.tipTraits" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="2" asMatrix="true">
			<parameter id="simTrait.leafTraits"/>
		</nodeTraits>
    </treeModel>

    <multivariateDiffusionModel id="simTrait.diffusionModel">
        <precisionMatrix>
            <cachedMatrixInverse id="simTrait.precision.matrix">
                <compoundSymmetricMatrix id="simTrait.variance.matrix" asCorrelation="true" isCholesky="true">
                    <diagonal>
                        <parameter id="simTrait.variance.diagonal" value="1 1" lower="0 0"/>
                    </diagonal>
                    <offDiagonal>
                        <parameter id="simTrait.variance.offDiagonal" value="0"/>
                    </offDiagonal>
                </compoundSymmetricMatrix>
            </cachedMatrixInverse>
        </precisionMatrix>
	</multivariateDiffusionModel>

    <parameter id="simTrait.opt.1" value="0.0"/>
    <parameter id="simTrait.opt.2" value="0.0"/>

	<diagonalMatrix id="simTrait.attenuation.matrix">
		<parameter id="simTrait.attenuation.values" value="1 1" lower="0 0"/>
	</diagonalMatrix>

	<repeatedMeasuresModel id="simTrait.repeatedMeasures" traitName="simTrait" >
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="simTrait.leafTraits"/>
		</traitParameter>
		<samplingPrecision>
			<cachedMatrixInverse id="simTrait.sampling.precision.matrix">
				<compoundSymmetricMatrix id="simTrait.sampling.variance.matrix" asCorrelation="true" isCholesky="true">
					<diagonal>
						<parameter id="simTrait.sampling.variance.diagonal" value="1 0.01" lower="0 0"/>
					</diagonal>
					<offDiagonal>
						<parameter id="simTrait.sampling.variance.offDiagonal" value="0"/>
					</offDiagonal>
				</compoundSymmetricMatrix>
			</cachedMatrixInverse>
		</samplingPrecision>
		<multivariateDiffusionModel idref="simTrait.diffusionModel"/>
	</repeatedMeasuresModel>

    <traitDataLikelihood id="simTrait.traitLikelihood" traitName="simTrait" 
        useTreeLength="false" scaleByTime="true" 
        forceFullPrecision="true" allowSingular="true"
        reportAsMultivariate="true" integrateInternalTraits="true">
		<multivariateDiffusionModel idref="simTrait.diffusionModel"/>
		<transformedTreeModel>
		    <treeModel idref="treeModel"/>
		    <parameter id="simTrait.lambda" value="1.0" lower="0.0" upper="1.0"/>
		</transformedTreeModel>
		<conjugateRootPrior>
            <meanParameter>
                <compoundParameter id="simTrait.meanParameter">
                    <parameter idref="simTrait.opt.1"/>
                    <parameter idref="simTrait.opt.2"/>
                </compoundParameter>
            </meanParameter>
            <priorSampleSize>
                <parameter value="Infinity"/> <!-- 1 is probably a good number -->
            </priorSampleSize>
		</conjugateRootPrior>
		<optimalTraits id="simTrait.opt">
		<strictClockBranchRates>
			<rate>
				<parameter idref="simTrait.opt.1"/>
			</rate>
		</strictClockBranchRates>
		<strictClockBranchRates>
			<rate>
				<parameter idref="simTrait.opt.2"/>
			</rate>
		</strictClockBranchRates>
		</optimalTraits>
		<strengthOfSelectionMatrix>
			<matrixParameter idref="simTrait.attenuation.matrix"/>
		</strengthOfSelectionMatrix>
		<repeatedMeasuresModel idref="simTrait.repeatedMeasures"/>
	</traitDataLikelihood>
	
	<varianceProportionStatistic id="varianceLog" matrixRatio="coheritability" usePopulationVariance="true">
        <traitDataLikelihood idref="simTrait.traitLikelihood"/>
    </varianceProportionStatistic>
    
     <assertEqual tolerance="1e-1" verbose="true" charactersToStrip="{}">
        <message>
            Check trait variance
        </message>
        <actual regex="(?s)stat value = \s*(.*?)\n\n">
            <varianceProportionStatistic idref="varianceLog"/>
        </actual>
        <expected>
            0.3018380  0.0000000
            0.0000000  0.9773926
        </expected>
    </assertEqual>
	
	<LKJCorrelationPrior id="simTrait.variance.offDiagonal.prior" shapeParameter="1.0" dimension="2">
		<data>
            <parameter idref="simTrait.variance.offDiagonal"/>
		</data>
	</LKJCorrelationPrior>
	<halfTPrior id="simTrait.variance.diagonal.prior" df="1" scale="2.5">
		<parameter idref="simTrait.variance.diagonal"/>
	</halfTPrior>
	<normalPrior id="simTrait.meanParameter.prior" mean="0" stdev="5">
		<parameter idref="simTrait.meanParameter"/>
	</normalPrior>
				<halfNormalPrior id="simTrait.attenuation.values.prior" mean="0" stdev="7.07306">
					<parameter idref="simTrait.attenuation.values"/>
				</halfNormalPrior>
	
				<halfTPrior id="simTrait.sampling.variance.diagonal.prior" df="1" scale="2.5">
					<parameter idref="simTrait.sampling.variance.diagonal"/>
				</halfTPrior>
	<diffusionGradient id="diffusion.gradient">
        <precisionGradient parameter="both" traitName="simTrait">
            <traitDataLikelihood idref="simTrait.traitLikelihood"/>
            <cachedMatrixInverse idref="simTrait.precision.matrix"/>
        </precisionGradient>
		<attenuationGradient parameter="diagonal" traitName="simTrait">
			<traitDataLikelihood idref="simTrait.traitLikelihood"/>
			<compoundSymmetricMatrix idref="simTrait.attenuation.matrix"/>
		</attenuationGradient>
		<meanGradient parameter="both" traitName="simTrait">
            <traitDataLikelihood idref="simTrait.traitLikelihood"/>
            <parameter idref="simTrait.meanParameter"/>
        </meanGradient>
    </diffusionGradient>
	
	<precisionGradient id="errorModel.gradient"  parameter="diagonal" traitName="simTrait">
		<repeatedMeasuresModel idref="simTrait.repeatedMeasures"/>
		<traitDataLikelihood idref="simTrait.traitLikelihood"/>
		<compoundSymmetricMatrix idref="simTrait.sampling.precision.matrix"/>
	</precisionGradient>

	<compoundGradient id="simTrait.traitLikelihood.gradient">
		<diffusionGradient idref="diffusion.gradient"/>
		<precisionGradient idref="errorModel.gradient"/>
	</compoundGradient>
	<report>
        <diffusionGradient idref="simTrait.traitLikelihood.gradient"/>
    </report>

    <compoundGradient id="simTrait.prior.gradient">
        <gradient>
            <halfTPrior idref="simTrait.variance.diagonal.prior"/>
            <parameter idref="simTrait.variance.diagonal"/>
        </gradient>
        <gradient>
            <LKJCorrelationPrior idref="simTrait.variance.offDiagonal.prior"/>
        </gradient>
		<gradient>
			<distributionLikelihood idref="simTrait.attenuation.values.prior"/>
			<parameter idref="simTrait.attenuation.values"/>
		</gradient>
        <gradient>
            <distributionLikelihood idref="simTrait.meanParameter.prior"/>
            <parameter idref="simTrait.meanParameter"/>
        </gradient>
		<gradient>
			<halfTPrior idref="simTrait.sampling.variance.diagonal.prior"/>
			<parameter idref="simTrait.sampling.variance.diagonal"/>
		</gradient>
    </compoundGradient>

    <jointGradient id="simTrait.posterior.gradient">
        <diffusionGradient idref="simTrait.traitLikelihood.gradient"/>
        <compoundGradient idref="simTrait.prior.gradient"/>
    </jointGradient>
    
    <operators id="operators">
        <hamiltonianMonteCarloOperator weight="1" nSteps="10" stepSize="0.01" mode="vanilla"
                                       drawVariance="1.0" gradientCheckCount="1" gradientCheckTolerance="0.5">
            <pathGradient>
                <source>
                    <gradient idref="simTrait.posterior.gradient"/>
                </source>
                <destination>
                    <gradient idref="simTrait.prior.gradient"/>
                </destination>
            </pathGradient>
            <compoundParameter id="simTrait.compound.parameter">
                <parameter idref="simTrait.variance.diagonal"/>
                <parameter idref="simTrait.variance.offDiagonal"/>
				<parameter idref="simTrait.attenuation.values"/>
                <parameter idref="simTrait.meanParameter"/>
				<parameter idref="simTrait.sampling.variance.diagonal"/>
            </compoundParameter>
            <multivariateCompoundTransform id="simTrait.compound.transform">
                <transform type="log" dim="2"/>
                <LKJTransform dimension="2"/>
				<transform type="log" dim="2"/>
                <transform type="none" dim="2"/>
				<transform type="log" dim="2"/>
            </multivariateCompoundTransform>
        </hamiltonianMonteCarloOperator>
	</operators>

	<mcmc id="mcmc" chainLength="100" autoOptimize="true"> 
		<posterior id="posterior">
			<prior id="prior">
                <LKJCorrelationPrior idref="simTrait.variance.offDiagonal.prior"/>
				<halfNormalPrior idref="simTrait.attenuation.values.prior"/>
                <halfTPrior idref="simTrait.variance.diagonal.prior"/>
				<normalPrior idref="simTrait.meanParameter.prior"/>
				<halfTPrior idref="simTrait.sampling.variance.diagonal.prior"/>
			</prior>
			<likelihood id="likelihood">
                <traitDataLikelihood idref="simTrait.traitLikelihood"/>
			</likelihood>
		</posterior>

		<operators idref="operators"/>

		<log id="screenLog" logEvery="100">
			<column label="Posterior" dp="4" width="12">
				<posterior idref="posterior"/>
			</column>
			<column label="Prior" dp="4" width="12">
				<prior idref="prior"/>
			</column>
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood"/>
			</column>
			<column label="rootHeight" sf="6" width="12">
				<parameter idref="treeModel.rootHeight"/>
			</column>
			<column label="heritability" dp="4" width="12">
				<variancePorportionStatistic idref="varianceLog"/>
			</column>
		</log>
				
		<log id="fileLog" logEvery="10" fileName="testRepeatedMeasuresOUHMC.log">
			<traitDataLikelihood idref="simTrait.traitLikelihood"/>
			<matrixParameter idref="simTrait.variance.matrix"/>
			<parameter idref="simTrait.meanParameter"/>
			<parameter idref="simTrait.attenuation.matrix"/>
			<parameter idref="simTrait.sampling.variance.matrix"/>
			<variancePorportionStatistic idref="varianceLog"/>
		</log>
		
		<logTree id="treeFileLog" logEvery="10" nexusFormat="true" fileName="testRepeatedMeasuresOUHMC.trees">
			<treeModel idref="treeModel"/>
		</logTree>
						
	</mcmc>
	
	<report>
	Time Chain: 
		<property name="timer">
			<mcmc idref="mcmc"/>
		</property>
	</report>
	
	<assertEqual tolerance="1e-2" verbose="true" charactersToStrip="{}">
        <message>
            Check trait variance
        </message>
        <actual regex="(?s)stat value = \s*(.*?)\n\n">
            <varianceProportionStatistic idref="varianceLog"/>
        </actual>
        <expected>
			0.9994180   0.022429281  
			0.022429281 0.8911881
        </expected>
    </assertEqual>

</beast>

<!--
# R function to compute heritability (for comparisons)

rm(list = ls())

library(here)
library(tidyverse)
library(PhylogeneticEM)

###############################################################################
## Utility functions

read_log <- function(file, burning){
  ## Read in file
  dat <- read_tsv(file, skip = 3)
  
  ## Burning
  length_chain <- max(dat$state)
  burning_length <- floor(length_chain * burning)
  
  ## data
  return(dat %>% filter(state >= burning_length))
}

cor_extended <- function(A, B) {
  C <- A
  for (i in 1:nrow(A)) {
    for (j in 1:ncol(A)) {
      C[i, j] <- C[i, j] / sqrt((A[i, i] + B[i, i]) * (A[j, j] + B[j, j]))
    }
  }
  return(C)
}

get_sampling_variance <- function(vv, dimTrait, times_shared, treeScaled){
  # samplingVar <- as.vector(solve(matrix(as.numeric(vv[grep("sampling.precision.matrix", names(vv))]), ncol = dimTrait)))
  samplingVar <- as.vector(matrix(as.numeric(vv[grep("sampling.variance.matrix", names(vv))]), ncol = dimTrait))
  if (treeScaled) samplingVar <- mean(diag(times_shared)) * samplingVar
  return(samplingVar)
}

compute_heritability_multi_ou_model <- function(dimTrait, variance, selectionStrength, sampleSizeRoot, samplingVar, times_shared, ntaxa) {
  get_ou_variance <- function(dimTrait, variance, selectionStrength, sampleSizeRoot) {
    if (anyNA(selectionStrength)) selectionStrength <- matrix(0, dimTrait, dimTrait)
    if (is.finite(sampleSizeRoot)){
      paramsBEAST <- params_OU(p = dimTrait, variance = variance,
                               selection.strength = selectionStrength,
                               optimal.value = rep(0, dimTrait),
                               random = TRUE, stationary.root = FALSE,
                               exp.root = rep(0, dimTrait), var.root = variance / sampleSizeRoot)
    } else {
      paramsBEAST <- params_OU(p = dimTrait, variance = variance,
                               selection.strength = selectionStrength,
                               optimal.value = rep(0, dimTrait),
                               random = FALSE, stationary.root = FALSE,
                               value.root = rep(0, dimTrait))
    }
    V <- PhylogeneticEM:::compute_variance_block_diagonal.OU(times_shared, paramsBEAST, ntaxa)
  }
  vv <- get_ou_variance(dimTrait, variance, selectionStrength, sampleSizeRoot)
  treeVar <- apply(vv, c(1, 2), mean)
  # return(treeVar %*% solve(treeVar + samplingVar))
  cor_extended(treeVar, samplingVar)
}

compute_heritability_multi_ou_varying_trees <- function(dat_log, dat_tree, traitName, dimTrait, sampleSizeRoot, treeScaled = FALSE) {
  if (nrow(dat_log) != length(dat_tree)) stop("Parameter log and tree log must be of the same length.")
  sum_vars <- function(i) {
    var <- matrix(as.numeric(dat_log[i, colPrecMat]), dimTrait, dimTrait)
    att <- matrix(as.numeric(dat_log[i, colAttMat]), dimTrait, dimTrait)
    tree <- dat_tree[[i]]
    ntaxa <- length(tree$tip.label)
    tree$edge.length <- tree$edge.length / max(ape::node.depth.edgelength(dat_tree[[i]])[1:ntaxa]) # Normalize tree
    times_shared <- PhylogeneticEM::compute_times_ca(tree)
    samplingVar <- matrix(get_sampling_variance(dat_log[i, ], dimTrait, times_shared = times_shared, treeScaled = treeScaled), dimTrait, dimTrait)
    compute_heritability_multi_ou_model(dimTrait, var, att, sampleSizeRoot, samplingVar, times_shared, ntaxa)
  }
  ## Trait tree variance
  colPrecMat <- grep(paste0(traitName, ".variance.matrix"), colnames(dat_log))
  colAttMat <- grep(paste0(traitName,".attenuation.matrix"), colnames(dat_log))
  hh <- sapply(1:length(dat_tree), sum_vars)
  if (is.vector(hh)) return(t(t(hh)))
  return(t(hh))
}

###############################################################################
## House keeping

## Directory
directory <- "."
results_folder <- ""
file_results <- file.path(results_folder, "testRepeatedMeasuresOUHMC.log")

## Parameters
dimTrait <- 2
sampleSizeRoot <- Inf
traitName <- "simTrait"
tree_scaled = FALSE

###############################################################################
## Heritability

dat_log <- read_log(file = file.path(directory, results_folder, file_results), burning = 0)

dat_tree <- ape::read.nexus(file = file.path(directory, results_folder, sub("\\.log", "\\.trees", file_results)))

herr <- compute_heritability_multi_ou_varying_trees(dat_log, dat_tree, traitName, dimTrait, sampleSizeRoot, treeScaled = tree_scaled)

colnames(herr) <- paste0(traitName, ".h", outer(1:dimTrait, 1:dimTrait, paste0))
herr <- data.frame(herr)
herr$state <- dat_log$state
herr
-->

<!--
## R simulation script
library(mvMORPH)

set.seed(20200611)

## Simluate a tree
n <- 50
tree <- rphylo(n, birth = 0.1, death = 0)
# Normalise to unit height
tree$edge.length <- tree$edge.length / max(diag(vcv(tree)))

## Simulate trait
p <- 2
sigma2 <- matrix(c(0.1, 0.01, 0.01, 0.2), p, p)
theta <- c(1.0, -1.0)
alpha <- matrix(c(1, 0, 0, 2), p, p)
sigma2_err <- c(0.01, 0.2)
errors <- matrix(rep(sigma2_err, each = n), n, p)
rownames(errors) <- tree$tip.label

trait <- mvSIM(tree = tree,
               nsim = 1,
               error = matrix(),
               model = "OU1",
               param = list(theta = theta, sigma = sigma2, alpha = alpha))

trait
write.tree(tree)
-->
