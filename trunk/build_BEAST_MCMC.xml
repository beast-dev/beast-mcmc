<!-- Build BEAST MCMC. It is also used by Hudson BEAST_MCMC project. JUnit test is available for this build. -->
<project basedir="." default="build_all_BEAST" name="BUILD_BEAST_MCMC">
	<description>
		Build BEAST MCMC. It is also used by Hudson BEAST_MCMC project. JUnit test is available for this build.
	    $Id: build_BEAST_MCMC.xml,v 1.5 2009/04/15 Walter Xie Exp $
	</description>

	<!-- set global properties for this build -->
	<property name="src" location="src" />
	<property name="build" location="bin" />
	<property name="lib" location="lib" />
	<property name="dist" location="bin/dist" />

	<property name="main_class_BEAST" value="dr.app.beast.BeastMain" />
	<property name="main_class_BEAUTI" value="dr.app.beauti.BeautiApp" />
	<property name="main_class_TRACER" value="dr.app.tracer.application.TracerApp" />
	<property name="main_class_Annotator" value="dr.app.tools.TreeAnnotator" />
	<property name="main_class_LogCombiner" value="dr.app.tools.LogCombiner" />
	<property name="report"  value="${build}/junitreport"/>

	<path id="classpath">
		<fileset dir="${lib}" includes="**/*.jar"/>
	</path>

	<!-- start -->
	<target name="init">
		<echo message="${ant.project.name}: ${ant.file}" />
	</target>

	<target name="clean">
		<delete dir="bin" />
	</target>

	<!-- clean previous build, and then compile Java source code, and Juint test -->
	<target name="build_all_BEAST" depends="clean,compile-all,junit"
        description="Clean and Build all run-time stuff">
	</target>

	<!-- clean previous build, compile Java source code, and Juint test, and make the beast.jar and beauti.jar -->
	<target name="build_jar_all_BEAST" depends="clean,compile-all,junit,dist_all_BEAST"
        description="Clean and Build all run-time stuff">
	</target>

	<!-- No JUnit Test, clean previous build, compile Java source code, and make the beast.jar and beauti.jar -->
	<target name="build_jar_all_BEAST_NoJUnitTest" depends="clean,compile-all,dist_all_BEAST"
        description="Clean and Build all run-time stuff">
	</target>

	<!-- compile Java source code -->
	<target name="compile-all" depends="init">
		<mkdir dir="${build}" />

		<!-- Compile the java code from ${src} into ${build} /bin -->
		<javac source="1.5" srcdir="${src}" destdir="${build}" classpathref="classpath">
			<include name="dr/app/beast/**" />
			<include name="dr/app/beauti/**" />
			<include name="dr/app/tracer/**"/>
			<include name="dr/app/oldbeauti/**" />
			<include name="dr/app/beagle/**" />
			<include name="dr/app/seqgen/**" />
			<include name="dr/app/tools/**" />
			<include name="dr/app/util/**" />
			<include name="dr/evolution/**" />
			<include name="dr/evomodel/**" />
			<include name="dr/evomodelxml/**" />
			<include name="dr/evoxml/**" />
			<include name="dr/exporters/**" />
			<include name="dr/gui/chart/**" />
			<include name="dr/gui/tree/**" />
			<include name="dr/inference/**" />
			<include name="dr/inferencexml/**"/>
			<include name="dr/math/**" />
			<include name="dr/matrix/**" />
			<include name="dr/stats/**" />
			<include name="dr/util/**" />
			<include name="dr/xml/**" />
			<include name="dr/geo/**"/>
			<include name="dr/java16compat/**"/>
			<include name="org/virion/jam/**" />
			<!-- complie JUnit test classes -->
			<include name="test/dr/**" />
		</javac>
		<echo message="Successfully complied." />
	</target>

	<!-- make the beast.jar and beauti.jar -->
	<target name="dist_all_BEAST" depends="compile-all" description="create BEAST + BEAUTI jar">
		<!-- Create the distribution directory -->
		<mkdir dir="${dist}" />

		<!-- Put everything in ${build} into the beast.jar file -->
		<jar jarfile="${dist}/beast.jar">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Main-Class" value="${main_class_BEAST}" />
			</manifest>
			<fileset dir="${build}">
				<include name="dr/app/beast/**/*.class" />
				<!--<include name="dr/app/beastdev/**/*.class"/>-->
				<include name="dr/app/beauti/**/*.class" />
				<include name="dr/app/seqgen/**" />
				<include name="dr/app/util/**/*.class" />
				<include name="dr/app/tools/**/*.class" />
				<include name="dr/evolution/**/*.class" />
				<exclude name="dr/evomodel/beagle/**" />
				<include name="dr/evomodel/**/*.class" />
				<include name="dr/evoxml/**/*.class" />
				<include name="dr/evomodelxml/**" />
				<include name="dr/exporters/**/*.class" />
				<include name="dr/gui/tree/**/*.class" />
				<include name="dr/inference/**/*.class" />
				<include name="dr/inferencexml/**/*.class"/>
				<include name="dr/math/**/*.class" />
				<include name="dr/matrix/**/*.class" />
				<include name="dr/stats/**/*.class" />
				<include name="dr/util/**/*.class" />
				<include name="dr/xml/**/*.class" />
				<include name="dr/geo/**/*.class"/>
				<include name="dr/java16compat/**/*.class"/>
				<include name="org/virion/jam/**/*.class" />
			</fileset>
			<fileset dir="">
				<include name="images/*.png" />
			</fileset>
			<fileset dir="${src}">
				<include name="dr/**/*.png" />
				<include name="org/virion/jam/**/*.png" />
				<include name="dr/**/*.properties" />
			</fileset>
			<zipgroupfileset dir="${lib}" includes="jebl.jar" />
			<zipgroupfileset dir="${lib}" includes="jdom.jar" />
			<zipgroupfileset dir="${lib}" includes="beagle.jar" />
			<zipgroupfileset dir="${lib}" includes="commons-math-1.2.jar" />
			<zipgroupfileset dir="${lib}" includes="mtj.jar" />
			<zipgroupfileset dir="${lib}" includes="JRI.jar" />
			<zipgroupfileset dir="${lib}" includes="colt.jar" />
		</jar>

		<!-- Put everything in ${build} into the beauti.jar file -->
		<jar jarfile="${dist}/beauti.jar">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Main-Class" value="${main_class_BEAUTI}" />
			</manifest>
			<fileset dir="${build}">
				<include name="dr/app/beast/BeastVersion.class" />
				<include name="dr/app/beauti/**/*.class" />
				<include name="dr/app/oldbeauti/**/*.class" />
				<include name="dr/app/util/**/*.class" />
				<include name="dr/evolution/alignment/**/*.class" />
				<include name="dr/evolution/coalescent/**/*.class" />
				<include name="dr/evolution/colouring/**/*.class" />
				<include name="dr/evolution/datatype/**/*.class" />
				<include name="dr/evolution/distance/**/*.class" />
				<include name="dr/evolution/io/**/*.class" />
				<include name="dr/evolution/parsimony/**/*.class" />
				<include name="dr/evolution/sequence/**/*.class" />
				<include name="dr/evolution/tree/**/*.class" />
				<include name="dr/evolution/util/**/*.class" />
				<include name="dr/evomodel/branchratemodel/**/*.class" />
				<include name="dr/evomodel/clock/**/*.class" />
				<include name="dr/evomodel/coalescent/**/*.class" />
				<include name="dr/evomodel/indel/**/*.class" />
				<include name="dr/evomodel/operators/**/*.class" />
				<include name="dr/evomodel/sitemodel/**/*.class" />
				<include name="dr/evomodel/speciation/**/*.class" />
				<include name="dr/evomodel/substmodel/**/*.class" />
				<include name="dr/evomodel/tree/**/*.class" />
				<include name="dr/evomodel/treelikelihood/**/*.class" />
				<include name="dr/evomodelxml/**/*.class" />
				<include name="dr/evoxml/**/*.class" />
				<include name="dr/gui/chart/**" />
				<include name="dr/gui/table/**" />
				<include name="dr/gui/tree/**" />
				<include name="dr/inference/**/*.class" />
				<include name="dr/inferencexml/**/*.class"/>
				<include name="dr/math/**/*.class" />
				<include name="dr/matrix/**/*.class" />
				<include name="dr/stats/**/*.class" />
				<include name="dr/util/**/*.class" />
				<include name="dr/xml/**/*.class" />
				<include name="dr/geo/**/*.class"/>
				<include name="dr/java16compat/**/*.class"/>
				<include name="org/virion/jam/**/*.class" />
			</fileset>
			<fileset dir="">
				<include name="images/*.png" />
			</fileset>
			<fileset dir="${src}">
				<include name="dr/**/*.png" />
				<include name="org/virion/jam/**/*.png" />
			</fileset>
			<zipgroupfileset dir="${lib}" includes="jebl.jar" />
			<zipgroupfileset dir="${lib}" includes="jdom.jar" />
			<zipgroupfileset dir="${lib}" includes="commons-math-1.2.jar" />
			<zipgroupfileset dir="${lib}" includes="mtj.jar" />
		</jar>

		<!-- <jar jarfile="${dist}/treeannotator.jar">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Main-Class" value="${main_class_Annotator}" />
			</manifest>
			<fileset dir="${build}">
				<include name="dr/app/beast/**/*.class" />
				<include name="dr/app/util/**/*.class" />
				<include name="dr/app/tools/**/*.class" />
				<include name="dr/evolution/**/*.class" />
				<include name="dr/evomodel/**/*.class" />
				<include name="dr/evoxml/**/*.class" />
				<include name="dr/evomodelxml/**" />
				<include name="dr/geo/**/*.class" />
				<include name="dr/exporters/**/*.class" />
				<include name="dr/gui/tree/**/*.class" />
				<include name="dr/inference/**/*.class" />
				<include name="dr/math/**/*.class" />
				<include name="dr/matrix/**/*.class" />
				<include name="dr/stats/**/*.class" />
				<include name="dr/util/**/*.class" />
				<include name="dr/xml/**/*.class" />
				<include name="org/virion/jam/**/*.class" />
				<include name="org/rosuda/JRI/**/*.class" />
			</fileset>
			<fileset dir="">
				<include name="images/*.png" />
			</fileset>
			<fileset dir="${src}">
				<include name="dr/**/*.png" />
				<include name="org/virion/jam/**/*.png" />
				<include name="dr/**/*.properties" />
			</fileset>
			<zipgroupfileset dir="${lib}" includes="jebl.jar" />
			<zipgroupfileset dir="${lib}" includes="jdom.jar" />
			<zipgroupfileset dir="${lib}" includes="beagle.jar" />
			<zipgroupfileset dir="${lib}" includes="commons-math-1.2.jar" />
			<zipgroupfileset dir="${lib}" includes="mtj.jar" />
			<zipgroupfileset dir="${lib}" includes="JRI.jar" />
			<zipgroupfileset dir="${lib}" includes="colt.jar" />
		</jar>
		
		<jar jarfile="${dist}/tracer.jar">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Main-Class" value="${main_class_TRACER}" />
			</manifest>
			<fileset dir="${build}">
				<include name="dr/app/tracer/**/*.class" />
				<include name="dr/app/util/**/*.class" />
				<include name="dr/evolution/alignment/**/*.class" />
				<include name="dr/evolution/coalescent/**/*.class" />
				<include name="dr/evolution/colouring/**/*.class" />
				<include name="dr/evolution/datatype/**/*.class" />
				<include name="dr/evolution/distance/**/*.class" />
				<include name="dr/evolution/io/**/*.class" />
				<include name="dr/evolution/parsimony/**/*.class" />
				<include name="dr/evolution/sequence/**/*.class" />
				<include name="dr/evolution/tree/**/*.class" />
				<include name="dr/evolution/util/**/*.class" />
				<include name="dr/gui/chart/**/*.class" />
				<include name="dr/inference/**/*.class" />
				<include name="dr/math/**/*.class" />
				<include name="dr/matrix/**/*.class" />
				<include name="dr/stats/**/*.class" />
				<include name="dr/util/**/*.class" />
				<include name="dr/xml/**/*.class" />
				<include name="dr/java16compat/**/*.class" />
			</fileset>
			<fileset dir="${src}">
				<include name="dr/app/tracer/**/*.png" />
				<include name="dr/app/tracer/**/*.gif" />
				<include name="dr/app/tracer/**/*.tiff" />
				<include name="org/virion/jam/**/*.png" />
			</fileset>
			<zipgroupfileset dir="${lib}" includes="jebl.jar" />
			<zipgroupfileset dir="${lib}" includes="itext-1.4.5.jar" />
			<zipgroupfileset dir="${lib}" includes="commons-math-1.2.jar" />
		</jar> -->

		<!-- Put everything in ${build} into the beast.jar file -->
		<jar jarfile="${dist}/beast-beagle.jar">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
			</manifest>
			<fileset dir="${build}">
				<include name="dr/app/beagle/**/*.class" />
			</fileset>
			<zipgroupfileset dir="${lib}" includes="beagle.jar" />
		</jar>

	</target>

	<!-- run beast.jar -->
	<target name="run_BEAST">
		<java jar="${dist}/beast.jar" fork="true" />
	</target>

	<!-- run beauti.jar -->
	<target name="run_BEAUTI">
		<java jar="${dist}/beauti.jar" fork="true" />
	</target>

	<!-- run tracer.jar -->
	<target name="run_TRACER">
		<java jar="${dist}/tracer.jar" fork="true" />
	</target>

	<!-- JUnit test -->
	<target name="junit">
		<mkdir dir="${report}" />
		<junit printsummary="yes">
			<classpath>
				<path refid="classpath" />
				<path location="${build}" />
			</classpath>

			<formatter type="xml" />

			<batchtest fork="yes" todir="${report}">
				<fileset dir="${src}">
					<!-- <include name="test/dr/evomodel/**/*Test.java" /> -->
					<!-- <include name="test/dr/evomodel/arg/**/*Test.java" /> -->
					<include name="test/dr/evomodel/coalescent/**/*Test.java" />
					<!-- <include name="test/dr/evomodel/substmodel/**/*Test.java" /> -->
					<include name="test/dr/evomodel/substmodel/**/BinaryCovarionModelTest.java" />
					<include name="test/dr/evomodel/substmodel/**/CovarionHKYTest.java" />
					<include name="test/dr/evomodel/substmodel/**/HKYTest.java" />
					<include name="test/dr/evomodel/substmodel/**/TN93Test.java" />
					<!-- <include name="test/dr/evomodel/operators/**/*Test.java" /> -->
					<include name="test/dr/evomodel/operators/**/FNPRTest.java" />
					<include name="test/dr/evomodel/operators/**/NNITest.java" />
					<include name="test/dr/evomodel/speciation/**/*Test.java" />
					<include name="test/dr/inference/**/*Test.java"/>
					<include name="test/dr/distibutions/**/*Test.java"/>
				</fileset>
			</batchtest>
		</junit>
		<echo message="JUnit test finished." />
	</target>

	<target name="junitreport">
		<junitreport todir="${report}">
			<fileset dir="${report}" includes="*.xml"/>
			<report format="frames" todir="${report}"/>
		</junitreport>
		<echo message="JUnit test report finished." />
	</target>


	<property name="version" value="1.5.1" />
	<property name="release" value="release" />
	<property name="BEAST_release" value="BEAST v" />
	<property name="BEAUTi_release" value="BEAUTi v" />
	<property name="TreeAnnotator_release" value="TreeAnnotator v" />
	<property name="LogCombiner_release" value="LogCombiner v" />
	<property name="LogAnalyser_release" value="LogAnalyser v" />
	
	<!-- Need to either install Launch4j under {BEAST workspace}/${release}
	             or install it in the default directoy and change the location of launch4j.dir -->
	<target name="windows_Release" depends="build_jar_all_BEAST_NoJUnitTest"
								   description="release Windows version of BEAST, BEAUTI, TreeAnnotator, LogCombiner">
		<delete dir="${BEAST_release}${version}" />
		<!-- Create the release directory -->
		<mkdir dir="${BEAST_release}${version}" />

		<property name="launch4j.dir" location="${release}/launch4j" />
		<taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask" 
			classpath="${launch4j.dir}/launch4j.jar :${launch4j.dir}/lib/xstream.jar" />

		<copy todir="${BEAST_release}${version}/doc">
			<fileset dir="doc"/>
		</copy>
		<copy todir="${BEAST_release}${version}/examples">
			<fileset dir="examples"/>
		</copy>
		<copy todir="${BEAST_release}${version}/native">
			<fileset dir="native"/>
		</copy>
		<copy todir="${BEAST_release}${version}/scripts">
			<fileset dir="scripts"/>
		</copy>
		<copy file="${dist}/beauti.jar" todir="${BEAST_release}${version}/lib"/>
		<copy file="${dist}/beast.jar" todir="${BEAST_release}${version}/lib"/>
		<copy file="${dist}/beast-beagle.jar" todir="${BEAST_release}${version}/lib"/>
		<copy todir="${BEAST_release}${version}/lib">
			<fileset dir="${release}/extra_lib"/>
		</copy>
		<copy file="${release}/VERSION HISTORY.txt" todir="${BEAST_release}${version}"/>
		<copy file="${release}/README.txt" todir="${BEAST_release}${version}"/>
		
		<!-- BEAUTi v?.?.?.exe -->
		<launch4j configFile="${release}/BEAUTi_launch4j.xml"
		          jar="${dist}/beauti.jar"
				  outfile="${BEAST_release}${version}/${BEAUTi_release}${version}.exe"
		          fileVersion="${version}.0"
		          txtFileVersion="${version}"
		          productVersion="${version}.0"
		          txtProductVersion="${version}"/>

		<!-- BEAST v?.?.?.exe -->
		<launch4j configFile="${release}/BEAST_launch4j.xml"
		          jar="${dist}/beast.jar"
			      outfile="${BEAST_release}${version}/${BEAST_release}${version}.exe"
		          fileVersion="${version}.0"
		          txtFileVersion="${version}"
		          productVersion="${version}.0"
		          txtProductVersion="${version}"/>

		<!-- TreeAnnotator v?.?.?.exe -->
		<launch4j configFile="${release}/TreeAnnotator_launch4j.xml"
				  jar="${dist}/beast.jar"
				  outfile="${BEAST_release}${version}/${TreeAnnotator_release}${version}.exe"
				  fileVersion="${version}.0"
				  txtFileVersion="${version}"
				  productVersion="${version}.0"
				  txtProductVersion="${version}"/>

		<!-- LogCombiner v?.?.?.exe -->
		<launch4j configFile="${release}/LogCombiner_launch4j.xml"
				  jar="${dist}/beast.jar"
				  outfile="${BEAST_release}${version}/${LogCombiner_release}${version}.exe"
				  fileVersion="${version}.0"
				  txtFileVersion="${version}"
				  productVersion="${version}.0"
				  txtProductVersion="${version}"/>	
		
		<!-- LogAnalyser v?.?.?.exe 
		<launch4j configFile="${release}/LogAnalyser_launch4j.xml"
				  jar="${dist}/beast.jar"
				  outfile="${BEAST_release}${version}/${LogAnalyser_release}${version}.exe"
				  fileVersion="${version}.0"
				  txtFileVersion="${version}"
				  productVersion="${version}.0"
				  txtProductVersion="${version}"/>	-->
		
		<zip destfile="${release}/${BEAST_release}${version}.zip">  
			<zipfileset dir="${BEAST_release}${version}" prefix="${BEAST_release}${version}"/>
		</zip>

		<echo message="Windows version release is finished." />
	</target>
	
	<target name="linux_unix_Release" depends="build_jar_all_BEAST_NoJUnitTest"
								   description="release Linux/Unix version of BEAST, BEAUTI, TreeAnnotator, LogCombiner">
		<delete dir="${BEAST_release}${version}" />
		<!-- Create the release directory -->
		<mkdir dir="${BEAST_release}${version}" />
	
		<copy todir="${BEAST_release}${version}/bin">
			<fileset dir="scripts" excludes="*.cmd"/>
		</copy>
		<copy todir="${BEAST_release}${version}/doc">
			<fileset dir="doc"/>
		</copy>
		<copy todir="${BEAST_release}${version}/examples">
			<fileset dir="examples"/>
		</copy>
		<copy todir="${BEAST_release}${version}/native">
			<fileset dir="native"/>
		</copy>		
		<copy file="${release}/icons/beast.png" todir="${BEAST_release}${version}/images"/>
		<copy file="${release}/icons/beauti.png" todir="${BEAST_release}${version}/images"/>
		<copy file="${release}/icons/utility.png" todir="${BEAST_release}${version}/images"/>		
		<copy file="${dist}/beauti.jar" todir="${BEAST_release}${version}/lib"/>
		<copy file="${dist}/beast.jar" todir="${BEAST_release}${version}/lib"/>
		<copy file="${dist}/beast-beagle.jar" todir="${BEAST_release}${version}/lib"/>
		<copy todir="${BEAST_release}${version}/lib">
			<fileset dir="${release}/extra_lib"/>
		</copy>
		<copy file="${release}/VERSION HISTORY.txt" todir="${BEAST_release}${version}"/>
		<copy file="${release}/README.txt" todir="${BEAST_release}${version}"/>
			
		<tar destfile="${release}/${BEAST_release}${version}.tgz">  
			<tarfileset dir="${BEAST_release}${version}" prefix="${BEAST_release}${version}"/>
		</tar>

		<echo message="Linux/Unix version release is finished." />
	</target>

</project>
